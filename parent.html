<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <title>Class Map - Parent View</title>
  <style>
    body {
      margin: 0;
      font-family: "Heebo", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: #f3f4f6;
      direction: rtl;
      color: #111827;
    }

    .parent-shell {
      max-width: 860px;
      margin: 40px auto;
      padding: 0 16px 32px;
    }

    .question-card {
      background: #ffffff;
      border-radius: 22px;
      padding: 24px 26px 22px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
    }

    .question-header {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 12px;
    }

    .question-header h1 {
      margin: 0;
      font-size: 1.5rem;
    }

    .question-header p {
      margin: 0;
      font-size: 0.98rem;
      line-height: 1.7;
      color: #4b5563;
    }

    .progress {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .progress-text {
      font-size: 0.9rem;
      color: #6b7280;
    }

    .progress-dots {
      display: flex;
      gap: 0.35rem;
    }

    .progress-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      border: 1px solid #bbb;
      background: transparent;
      opacity: 0.4;
    }

    .progress-dot.active {
      background: #6c5ce7;
      border-color: #6c5ce7;
      opacity: 1;
    }

    .progress-dot.completed {
      background: #6c5ce7;
      border-color: #6c5ce7;
      opacity: 0.6;
    }

    .range-input {
      width: 100%;
      margin-top: 16px;
      accent-color: #d595e2;
    }

    .scale-row {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      margin-top: 8px;
    }

    .scale-label {
      flex: 1;
      text-align: center;
      font-size: 0.92rem;
      color: #4b5563;
      line-height: 1.4;
    }

    .status {
      margin-top: 0.9rem;
      font-size: 0.95rem;
      color: #1f2937;
    }

    .status.locked {
      color: #1a7a2e;
      font-weight: 500;
    }

    .buttons {
      display: flex;
      gap: 0.5rem;
      margin-top: 1.1rem;
    }

    .buttons button {
      flex: 1;
      padding: 0.65rem 1rem;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
    }

    .buttons button:last-child {
      background: #b47fc2;
      color: #fff;
      border-color: #5d4264;
    }

    #doneBlock {
      display: none;
      text-align: center;
      margin-top: 3rem;
    }

    @media (max-width: 600px) {
  .parent-shell {
    margin: 20px auto 24px;
    padding: 0 12px 24px;
  }

  .question-card {
    padding: 18px 16px 18px;
    border-radius: 18px;
    box-shadow: 0 12px 26px rgba(15, 23, 42, 0.12);
  }

  .question-header h1 {
    font-size: 1.25rem;
  }

  .question-header p {
    font-size: 0.95rem;
  }

  .scale-label {
    font-size: 0.86rem;
  }

  .buttons button {
    font-size: 0.9rem;
    padding: 0.55rem 0.9rem;
  }
}
  </style>
</head>
<body>
  <main class="parent-shell">
    <section class="question-card" id="questionBlock">
      <div class="question-header">
        <div class="progress">
          <div id="progressText" class="progress-text"></div>
          <div id="progressDots" class="progress-dots"></div>
        </div>
        <h1 id="qTitle">שאלה</h1>
        <p id="qDescription">תיאור השאלה יוצג כאן.</p>
      </div>

      <input
        id="rangeInput"
        class="range-input"
        type="range"
        min="0"
        max="100"
        step="1"
        value="50"
      />

      <div class="scale-row">
        <div class="scale-label" id="labelLeft"></div>
        <div class="scale-label" id="labelMid"></div>
        <div class="scale-label" id="labelRight"></div>
      </div>

      <div id="status" class="status">
        גררו את הסרגל כדי לבחור.
      </div>

      <div class="buttons">
        <button id="backBtn" type="button">חזרה</button>
        <button id="submitBtn" type="button">המשך</button>
      </div>
    </section>

    <div id="doneBlock">
      <h2>🙏 תודה</h2>
      <p>ענית על כל השאלות. אפשר להניח את הטלפון ולהמשיך להקשיב במפגש.</p>
    </div>
  </main>

  <script>
    // === CONFIG ===
    const SCRIPT_URL =
      "https://script.google.com/macros/s/AKfycbxroy8w-KkybITVHMqoXUB8vg3M4uHfMa22Op4mK2xeDXLEguxIm854IFaQF4JJ47Vo/exec";

    // Allow sessionId override from URL (like parent.html?sessionId=5A_2025-11-26)
    const urlParams = new URLSearchParams(location.search);
    const sessionId = urlParams.get("sessionId") || "5A_2025-11-26";

    // Stable parent ID (no optional chaining → works everywhere)
    let parentId = localStorage.getItem("classmap_parentId");
    if (!parentId) {
      if (
        typeof crypto !== "undefined" &&
        crypto &&
        typeof crypto.randomUUID === "function"
      ) {
        parentId = crypto.randomUUID();
      } else {
        parentId = String(Math.random()).slice(2);
      }
      localStorage.setItem("classmap_parentId", parentId);
    }

    // Fallback questions if questions.json fails
    const fallbackQuestions = [
    {
    id: "q1",
    title: "עד כמה הילד/ה מבין/ה את חשיבות המצפן",
    description: "כשאתן/ם חושבות/ים על הילד/ה שלכן/ם – עד כמה נראה לכם שהוא/היא מבין/ה למה יש “מצפן” בבית הספר ולמה הוא חשוב?",
    leftLabel: "מבין/ה היטב מה הרעיון ולמה זה חשוב בכיתה ובקהילה",
    middleLabel: "מבין/ה בגדול מה הרעיון, אבל זה לא ממש תופס מקום ביום־יום שלו/ה",
    rightLabel: "כמעט לא – זה מרגיש לו/ה כמו “עוד משהו שבית הספר מדבר עליו”"
    },

    {
    id: "q2",
    title: "איך הילד/ה חווה את הפער?",
    description: "אם יש פער בין הבית לקהילה – איך נראה לכם שהילד/ה חי/ה אותו?",
    leftLabel: "בסדר / מעשיר / לא משמעותי",
    middleLabel: "לפעמים מבלבל, לפעמים בסדר",
    rightLabel: "לעיתים קרובות מבלבל או מכאיב"
    },
  
   {
    id: "q3",
    title: "דיגיטל: סמארטפונים, מסכים, משחקים",
    description: "בנושא טלפונים חכמים, מסכים ומשחקים דיגיטליים – עד כמה נראה לכם שהילד/ה שלכם מרגיש/ה שהקו של המצפן דומה למה שהוא/היא חווה בפועל בבית ובסביבה?",
    leftLabel: "מרגיש/ה שהמסר די עקבי – פחות או יותר אותו כיוון בבית, בבית הספר ובחברים",
    middleLabel: "לפעמים זה מרגיש באותו כיוון ולפעמים לא – יש פערים",
    rightLabel: "מרגיש/ה שיש הבדל גדול – שומע/ת מסר אחד במצפן ומציאות אחרת בשטח"
   },
   
   {
    id: "q4",
    title: "חברתי: ימי הולדת, הזמנות, הדרה",
    description: "כשאתם חושבים על ימי הולדת והזמנות ילדים/ות מהכיתה – עד כמה נראה לכם שהילד/ה שלכם מרגיש/ה שהמצפן מתאר משהו שדומה למה שקורה באמת?",
    leftLabel: "מרגיש/ה שבגדול זה דומה – יש מאמץ לא להדיר ולהכליל",
    middleLabel: "החוויה מעורבת – יש גם רגעים של הכלה וגם רגעים כואבים יותר של הדרה",
    rightLabel: "מרגיש/ה שיש פער גדול – שומע/ת במצפן על הכלה, אבל בפועל חווה לא מעט הדרה / החמצות"
   }
    ];

    // === DOM ===
    const questionBlock = document.getElementById("questionBlock");
    const doneBlock = document.getElementById("doneBlock");
    const qTitleEl = document.getElementById("qTitle");
    const qDescriptionEl = document.getElementById("qDescription");
    const labelLeftEl = document.getElementById("labelLeft");
    const labelMidEl = document.getElementById("labelMid");
    const labelRightEl = document.getElementById("labelRight");
    const rangeInput = document.getElementById("rangeInput");
    const statusEl = document.getElementById("status");
    const backBtn = document.getElementById("backBtn");
    const submitBtn = document.getElementById("submitBtn");
    const progressTextEl = document.getElementById("progressText");
    const progressDotsEl = document.getElementById("progressDots");

    // === STATE ===
    let questions = [];
    let currentIndex = 0;
    let locked = false;
    const answers = {};

    // Describe slider value according to current labels
    function describeValue(value) {
      const v = Number(value);
      if (v <= 30) return labelLeftEl.textContent;
      if (v >= 70) return labelRightEl.textContent;
      return labelMidEl.textContent;
    }

    // === LOAD QUESTIONS FROM JSON (WITH CACHE-BUST) ===
    async function loadQuestions() {
      try {
        const res = await fetch("questions.json?cache=" + Date.now());
        console.log("questions.json status:", res.status);
        if (!res.ok) throw new Error("HTTP " + res.status);

        const loaded = await res.json();
        console.log("Loaded questions:", loaded);

        if (!Array.isArray(loaded) || loaded.length === 0) {
          throw new Error("questions.json empty or invalid");
        }
        questions = loaded;
      } catch (err) {
        console.warn("Using fallback questions:", err);
        questions = fallbackQuestions;
      }

      // Build progress dots
      progressDotsEl.innerHTML = "";
      for (let i = 0; i < questions.length; i++) {
        const dot = document.createElement("div");
        dot.className = "progress-dot";
        progressDotsEl.appendChild(dot);
      }

      currentIndex = 0;
      showCurrentQuestion();
    }

    function showCurrentQuestion() {
      if (currentIndex >= questions.length) {
        questionBlock.style.display = "none";
        doneBlock.style.display = "block";
        return;
      }

      const total = questions.length;
      const step = currentIndex + 1;
      const q = questions[currentIndex];

      locked = false;
      rangeInput.disabled = false;
      submitBtn.disabled = false;

      // Progress text
      progressTextEl.textContent = `שאלה ${step} מתוך ${total}`;

      // Progress dots
      const dots = progressDotsEl.children;
      for (let i = 0; i < dots.length; i++) {
        dots[i].classList.remove("active", "completed");
        if (i < currentIndex) dots[i].classList.add("completed");
        else if (i === currentIndex) dots[i].classList.add("active");
      }

      // Fill question + labels
      qTitleEl.textContent = q.title || "";
      qDescriptionEl.textContent = q.description || "";
      labelLeftEl.textContent = q.leftLabel || "";
      labelMidEl.textContent = q.middleLabel || "";
      labelRightEl.textContent = q.rightLabel || "";

      // Restore previous answer if exists
      const saved = answers[q.id];
      if (typeof saved === "number" && !Number.isNaN(saved)) {
        rangeInput.value = saved;
      } else {
        rangeInput.value = 50;
      }

      const val = rangeInput.value;
      const label = describeValue(val);
      statusEl.textContent = `הערכה נוכחית: ${label} (ערך: ${val})`;

      backBtn.disabled = currentIndex === 0;
      submitBtn.textContent =
        currentIndex === total - 1 ? "סיום" : "המשך";

      questionBlock.style.display = "block";
      doneBlock.style.display = "none";
    }

    // === EVENTS ===
    rangeInput.addEventListener("input", () => {
      if (locked) return;
      const val = rangeInput.value;
      const label = describeValue(val);
      statusEl.textContent = `הערכה נוכחית: ${label} (ערך: ${val})`;
    });

    backBtn.addEventListener("click", () => {
      if (locked) return;
      if (currentIndex === 0) return;
      currentIndex -= 1;
      showCurrentQuestion();
    });

    submitBtn.addEventListener("click", () => {
      if (locked) return;
      if (!questions[currentIndex]) return;

      locked = true;

      const q = questions[currentIndex];
      const questionId = q.id;
      const val = Number(rangeInput.value);
      const label = describeValue(val);

      answers[questionId] = val;
      statusEl.textContent = `נשמר. עוברים לשאלה הבאה... (${label}, ערך: ${val})`;

      const payload = JSON.stringify({
        sessionId,
        parentId,
        questionId,
        value: val,
      });
      const formData = new URLSearchParams();
      formData.append("payload", payload);

      fetch(SCRIPT_URL, {
        method: "POST",
        body: formData,
      }).catch((err) => {
        console.error("Background save error:", err);
      });

      setTimeout(() => {
        currentIndex += 1;
        locked = false;
        showCurrentQuestion();
      }, 200);
    });

    // === BOOT ===
    loadQuestions();
  </script>
</body>
</html>
