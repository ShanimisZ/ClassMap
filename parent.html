<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <title>Class Map - Parent View</title>
  <style>
    body {
      margin: 0;
      font-family: "Heebo", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
      sans-serif;
      background: #f3f4f6;
      direction: rtl;
      color: #111827;
    }

    .parent-shell {
      max-width: 860px;
      margin: 40px auto;
      padding: 0 16px 32px;
    }

    .question-card {
      background: #ffffff;
      border-radius: 22px;
      padding: 24px 26px 22px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
    }

    .question-header {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 12px;
    }

    .question-header h1 {
      margin: 0;
      font-size: 1.5rem;
    }

    .question-header p {
      margin: 0;
      font-size: 0.98rem;
      line-height: 1.7;
      color: #4b5563;
    }

    .progress {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .progress-text {
      font-size: 0.9rem;
      color: #6b7280;
    }

    .progress-dots {
      display: flex;
      gap: 0.35rem;
    }

    .progress-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      border: 1px solid #bbb;
      background: transparent;
      opacity: 0.4;
    }

    .progress-dot.active {
      background: #6c5ce7;
      border-color: #6c5ce7;
      opacity: 1;
    }

    .progress-dot.completed {
      background: #6c5ce7;
      border-color: #6c5ce7;
      opacity: 0.6;
    }

    .range-input {
      width: 100%;
      margin-top: 16px;
      accent-color: #6c5ce7;
    }

    .scale-row {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      margin-top: 8px;
    }

    .scale-label {
      flex: 1;
      text-align: center;
      font-size: 0.92rem;
      color: #4b5563;
      line-height: 1.4;
    }

    .status {
      margin-top: 0.9rem;
      font-size: 0.95rem;
      color: #1f2937;
    }

    .status.locked {
      color: #1a7a2e;
      font-weight: 500;
    }

    .buttons {
      display: flex;
      gap: 0.5rem;
      margin-top: 1.1rem;
    }

    .buttons button {
      flex: 1;
      padding: 0.65rem 1rem;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
    }

    .buttons button:last-child {
      background: #6c5ce7;
      color: #fff;
      border-color: #6c5ce7;
    }

    #doneBlock {
      display: none;
      text-align: center;
      margin-top: 3rem;
    }
  </style>
</head>
<body>
  <main class="parent-shell">
    <section class="question-card" id="questionBlock">
      <div class="question-header">
        <div class="progress">
          <div id="progressText" class="progress-text"></div>
          <div id="progressDots" class="progress-dots"></div>
        </div>
        <h1 id="qTitle">&#x05E9;&#x05D0;&#x05DC;&#x05D4;</h1>
        <p id="qDescription">&#x05EA;&#x05D9;&#x05D0;&#x05D5;&#x05E8; &#x05D4;&#x05E9;&#x05D0;&#x05DC;&#x05D4; &#x05D9;&#x05D5;&#x05E6;&#x05D2; &#x05DB;&#x05D0;&#x05DF;.</p>
      </div>

      <input id="rangeInput" class="range-input" type="range" min="0" max="100" step="1" value="50" />

      <div class="scale-row">
        <div class="scale-label" id="labelLeft"></div>
        <div class="scale-label" id="labelMid"></div>
        <div class="scale-label" id="labelRight"></div>
      </div>

      <div id="status" class="status">&#x05D2;&#x05E8;&#x05E8;&#x05D5; &#x05D0;&#x05EA; &#x05D4;&#x05E1;&#x05E8;&#x05D2;&#x05DC; &#x05DB;&#x05D3;&#x05D9; &#x05DC;&#x05D1;&#x05D7;&#x05D5;&#x05E8;.</div>

      <div class="buttons">
        <button id="backBtn" type="button">&#x05D7;&#x05D6;&#x05E8;&#x05D4;</button>
        <button id="submitBtn" type="button">&#x05D4;&#x05DE;&#x05E9;&#x05DA;</button>
      </div>
    </section>

    <div id="doneBlock">
      <h2>🙏 תודה</h2>
      <p>ענית על כל השאלות. אפשר להניח את הטלפון ולהמשיך להקשיב במפגש</p>
    </div>
  </main>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxroy8w-KkybITVHMqoXUB8vg3M4uHfMa22Op4mK2xeDXLEguxIm854IFaQF4JJ47Vo/exec"; // same as host.html
    const sessionId = "5A_2025-11-26";

    let parentId = localStorage.getItem("classmap_parentId");
    if (!parentId) {
      parentId = self.crypto?.randomUUID
        ? crypto.randomUUID()
        : String(Math.random()).slice(2);
      localStorage.setItem("classmap_parentId", parentId);
    }

    const fallbackQuestions = [
      {
        id: "q1",
        title: "How is your child feeling at school?",
        description: "Pick the point on the scale that fits best.",
        leftLabel: "Very challenging",
        middleLabel: "Neutral / sometimes",
        rightLabel: "Very positive"
      },
      {
        id: "q2",
        title: "How often does your child enjoy class activities?",
        description: "Choose the option that reflects the typical experience.",
        leftLabel: "Rarely",
        middleLabel: "Sometimes",
        rightLabel: "Most of the time"
      },
      {
        id: "q3",
        title: "How supported does your child feel by the teacher?",
        description: "Select the description that is closest to reality.",
        leftLabel: "Not supported",
        middleLabel: "Somewhat supported",
        rightLabel: "Very supported"
      }
    ];

    const questionBlock = document.getElementById("questionBlock");
    const doneBlock = document.getElementById("doneBlock");
    const qTitleEl = document.getElementById("qTitle");
    const qDescriptionEl = document.getElementById("qDescription");
    const labelLeftEl = document.getElementById("labelLeft");
    const labelMidEl = document.getElementById("labelMid");
    const labelRightEl = document.getElementById("labelRight");
    const rangeInput = document.getElementById("rangeInput");
    const status = document.getElementById("status");
    const backBtn = document.getElementById("backBtn");
    const submitBtn = document.getElementById("submitBtn");
    const progressTextEl = document.getElementById("progressText");
    const progressDotsEl = document.getElementById("progressDots");

    let questions = [];
    let currentIndex = 0;
    let locked = false;
    const answers = {};

    function describeValue(value) {
      const v = Number(value);
      if (v <= 30) return labelLeftEl.textContent;
      if (v >= 70) return labelRightEl.textContent;
      return labelMidEl.textContent;
    }

    async function loadQuestions() {
      try {
        const res = await fetch("questions.json");
        if (!res.ok) throw new Error("HTTP " + res.status);
        const loaded = await res.json();
        if (!Array.isArray(loaded) || loaded.length === 0) {
          throw new Error("questions.json empty or invalid");
        }
        questions = loaded;
      } catch (err) {
        console.warn("Using fallback questions:", err);
        questions = fallbackQuestions;
      }

      if (progressDotsEl) {
        progressDotsEl.innerHTML = "";
        for (let i = 0; i < questions.length; i++) {
          const dot = document.createElement("div");
          dot.className = "progress-dot";
          progressDotsEl.appendChild(dot);
        }
      }
      currentIndex = 0;
      showCurrentQuestion();
    }

    function showCurrentQuestion() {
      if (currentIndex >= questions.length) {
        questionBlock.style.display = "none";
        doneBlock.style.display = "block";
        return;
      }

      const total = questions.length;
      const step = currentIndex + 1;
      const q = questions[currentIndex];

      locked = false;
      rangeInput.disabled = false;
      submitBtn.disabled = false;

      if (progressTextEl) {
        progressTextEl.textContent = `\u05E9\u05D0\u05DC\u05D4 ${step} \u05DE\u05EA\u05D5\u05DA ${total}`;
      }
      if (progressDotsEl) {
        const dots = progressDotsEl.children;
        for (let i = 0; i < dots.length; i++) {
          dots[i].classList.remove("active", "completed");
          if (i < currentIndex) dots[i].classList.add("completed");
          else if (i === currentIndex) dots[i].classList.add("active");
        }
      }

      qTitleEl.textContent = q.title || "";
      qDescriptionEl.textContent = q.description || "";
      labelLeftEl.textContent = q.leftLabel || "";
      labelMidEl.textContent = q.middleLabel || "";
      labelRightEl.textContent = q.rightLabel || "";

      const saved = answers[q.id];
      if (typeof saved === "number" && !Number.isNaN(saved)) {
        rangeInput.value = saved;
      } else {
        rangeInput.value = 50;
      }

      const val = rangeInput.value;
      const label = describeValue(val);
      status.textContent = `\u05D4\u05E2\u05E8\u05DB\u05D4 \u05E0\u05D5\u05DB\u05D7\u05D9\u05EA: ${label} (\u05E2\u05E8\u05DA: ${val})`;

      backBtn.disabled = currentIndex === 0;
      submitBtn.textContent =
        currentIndex === total - 1 ? "\u05E1\u05D9\u05D5\u05DD" : "\u05D4\u05DE\u05E9\u05DA";

      questionBlock.style.display = "block";
      doneBlock.style.display = "none";
    }

    rangeInput.addEventListener("input", () => {
      if (locked) return;
      const val = rangeInput.value;
      const label = describeValue(val);
      status.textContent = `\u05D4\u05E2\u05E8\u05DB\u05D4 \u05E0\u05D5\u05DB\u05D7\u05D9\u05EA: ${label} (\u05E2\u05E8\u05DA: ${val})`;
    });

    backBtn.addEventListener("click", () => {
      if (locked) return;
      if (currentIndex === 0) return;
      currentIndex -= 1;
      showCurrentQuestion();
    });

    submitBtn.addEventListener("click", () => {
      if (locked) return;
      if (!questions[currentIndex]) return;

      locked = true;

      const q = questions[currentIndex];
      const questionId = q.id;
      const val = Number(rangeInput.value);
      const label = describeValue(val);

      answers[questionId] = val;
      status.textContent = `\u05E0\u05E9\u05DE\u05E8. \u05E2\u05D5\u05D1\u05E8\u05D9\u05DD \u05DC\u05E9\u05D0\u05DC\u05D4 \u05D4\u05D1\u05D0\u05D4... (${label}, \u05E2\u05E8\u05DA: ${val})`;

      const payload = JSON.stringify({
        sessionId,
        parentId,
        questionId,
        value: val
      });
      const formData = new URLSearchParams();
      formData.append("payload", payload);

      fetch(SCRIPT_URL, {
        method: "POST",
        body: formData
      }).catch(err => {
        console.error("Background save error:", err);
      });

      setTimeout(() => {
        currentIndex += 1;
        locked = false;
        showCurrentQuestion();
      }, 200);
    });

    loadQuestions();
  </script>
</body>
</html>


